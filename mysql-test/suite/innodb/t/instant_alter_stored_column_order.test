--disable_query_log
--disable_warnings
DROP DATABASE IF EXISTS instant_alter_stored_column_order;
CREATE DATABASE instant_alter_stored_column_order;
USE instant_alter_stored_column_order;
--enable_warnings
--enable_query_log

# PS-9222 Testing regression introduced by e6e13a8f, which causes engine crashed

--echo # PS-9222 - Testing if ALGORITHM=instant crashes server
CREATE TABLE t1 (c1 TINYTEXT COLLATE ascii_bin NOT NULL, c2 DATETIME(3) NOT NULL, c3 TEXT, PRIMARY KEY (c1(30)));
INSERT INTO t1 (c1, c2, c3) VALUE ('k1','2021-12-21','something');
INSERT INTO t1 (c1, c2, c3) VALUE ('k3','2021-12-21','something else');

ALTER TABLE t1 ADD COLUMN c4 VARCHAR(18) NOT NULL, algorithm=instant;
UPDATE t1 SET c4 = 'value' WHERE c1 = 'k1';

--echo # Restart the server and reload the table to see if tables are corrupted.
--source include/kill_and_restart_mysqld.inc

-- echo # Run a select to confirm that the database started up successfully
SELECT * FROM t1;
DROP TABLE t1;

# cleanup
--disable_query_log
--disable_warnings
DROP DATABASE instant_alter_stored_column_order;
--enable_warnings
--enable_query_log
